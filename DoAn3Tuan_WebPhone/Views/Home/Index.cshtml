@model DoAn3Tuan_WebPhone.ViewModels.HomePageViewModel
@{
    ViewData["Title"] = "Trang chủ";
}
@{
    Layout = null;
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cửa Hàng Điện Thoại Toàn Cầu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                Chào mừng đến với Cửa Hàng Điện Thoại Toàn Cầu
            </div>
            <div class="top-bar-right">
                <a href="#"><i class="fas fa-map-marker-alt"></i> Tìm Cửa Hàng</a>
                <a href="#"><i class="fas fa-truck"></i> Theo Dõi Đơn Hàng</a>
                <a href="#"><i class="fas fa-shopping-bag"></i> Cửa Hàng</a>
                <a href="#"><i class="fas fa-user"></i> Tài Khoản Của Tôi</a>
            </div>
        </div>
    </div>
  
    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">

                <!-- LOGO -->
                <a href="/" class="logo">electro<span>.</span></a>

                <!-- MENU -->
                <div class="burger-menu">
                    <i class="fas fa-bars"></i>
                </div>

                <!-- SEARCH FORM -->
                <div class="search-container">
                    <form action="/Search" method="get" style="display: flex; width: 100%;">

                        <input type="text" name="keyword" placeholder="Tìm kiếm sản phẩm..." value="@Context.Request.Query["keyword"]">

                        <button type="submit"><i class="fas fa-search"></i></button>
                    </form>
                </div>

                <!-- ICONS -->
                <div class="header-icons">

                    <a href="#" class="icon-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span class="icon-badge" id="compare-count">0</span>
                    </a>
                    <a href="/Home/Wishlist" class="icon-btn">
                        <i class="far fa-heart"></i>
                        <span class="icon-badge wishlist-badge">@(ViewBag.WishlistCount ?? 0)</span>
                    </a>

                    <!-- USER DROPDOWN -->
                    <div class="user-dropdown-container">
                        @if (Context.Session.GetString("MaKH") != null)
                        {
                            <a href="#" class="icon-btn user-icon">
                                <i class="fas fa-user"></i>
                                <span class="user-name-label">@Context.Session.GetString("TenUser")</span>
                            </a>
                            <div class="user-dropdown-content logged-in">
                                <h4 class="dropdown-title">Tài khoản của tôi</h4>
                                <a href="/Account/Profile"><i class="fas fa-id-card me-2"></i> Trang cá nhân</a>
                                <a href="/DonHang"><i class="fas fa-shopping-bag me-2"></i> Đơn hàng đã mua</a>
                                <div class="dropdown-divider"></div>
                                <a href="/Account/Logout" class="text-danger"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
                            </div>
                        }
                        else
                        {
                            <a href="#" class="icon-btn user-icon">
                                <i class="far fa-user"></i>
                            </a>

                            <div class="user-dropdown-content" id="authDropdown">
                                <div id="loginSection">
                                    <h4 class="dropdown-title">Đăng nhập</h4>
                                    <form action="/Account/Login" method="post">
                                        <input type="text" name="username" class="dropdown-input" placeholder="Tên đăng nhập" required />
                                        <input type="password" name="password" class="dropdown-input" placeholder="Mật khẩu" required />
                                        <button type="submit" class="btn-login">Đăng nhập</button>
                                    </form>
                                    <div class="dropdown-footer">
                                        <span>Chưa có tài khoản?</span>
                                        <a href="javascript:void(0)" onclick="toggleAuth('register')" class="link-register">Đăng ký ngay</a>
                                    </div>
                                </div>

                                <div id="registerSection" style="display: none;">
                                    <h4 class="dropdown-title">Đăng ký</h4>
                                    <form action="/Account/Register" method="post">
                                        <input type="text" name="hoten" class="dropdown-input" placeholder="Họ và tên" required />
                                        <input type="text" name="username" class="dropdown-input" placeholder="Tên đăng nhập" required />
                                        <input type="email" name="email" class="dropdown-input" placeholder="Email" required />
                                        <input type="password" name="password" class="dropdown-input" placeholder="Mật khẩu" required />
                                        <button type="submit" class="btn-login btn-register-submit">Tạo tài khoản</button>
                                    </form>
                                    <div class="dropdown-footer text-center mt-2">
                                        <a href="javascript:void(0)" onclick="toggleAuth('login')" class="link-register small">Quay lại Đăng nhập</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <!-- END USER DROPDOWN -->
                    <!-- CART -->
                    <div class="cart-info">
                        <a asp-controller="GioHang"
                           asp-action="Index"
                           class="icon-btn">                   
                        </a>
                            <i class="fas fa-shopping-cart"></i>
                            <span class="icon-badge">0</span>
                        </a>
                        <span class="cart-price">0 ₫</span>
                        <div class="cart-info">
                           <a asp-controller="GioHang"
                   asp-action="Index"
                   class="btn btn-outline-primary">
                    <i class="fa-solid fa-cart-shopping"></i> Giỏ hàng
                    </a>
                           
                        </div>
                        
>>>>>>> feature/bao-giohang-thanhtoan-canhan
                    </div>

                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container">
            <div class="nav-content">
                <ul class="nav-menu">
                   
                    <li><a asp-controller="Home" asp-action="Index">Trang Chủ</a></li>

                    <li><a asp-controller="Product" asp-action="Index">Sản Phẩm</a></li>

                    <li><a asp-controller="Home" asp-action="About">Giới Thiệu</a></li>

                    <li><a asp-controller="Contact" asp-action="Index">Liên Hệ</a></li>
                </ul>
                <div class="shipping-banner">
                    Miễn Phí Vận Chuyển Đơn Hàng Từ $50+
                </div>
            </div>
        </div>
    </nav>

    <section class="hero-clean-v4">
        <div class="hero-slider-owl owl-carousel owl-theme">
            @foreach (var sp in Model.SanPhamNoiBat)
            {
                string label; string slogan; string color;

                // Logic phân loại 3 nhóm nội dung
                if (sp.TenDienThoai.Contains("17") || sp.MaDienThoai == "DT041")
                {
                    label = "QUẢNG CÁO ĐẶC BIỆT";
                    slogan = "Khám phá tương lai công nghệ cùng siêu phẩm thế hệ mới";
                    color = "#0066cc"; // Xanh công nghệ
                }
                else if (sp.DonGia < 10000000)
                { //dưới 10tr là khuyến mãi
                    label = "KHUYẾN MÃI LỚN";
                    slogan = "Ưu đãi cực sốc - Giá tốt nhất thị trường hôm nay";
                    color = "#D10024"; // Đỏ giảm giá
                }
                else
                {
                    label = "SẢN PHẨM NỔI BẬT";
                    slogan = "Thiết kế đẳng cấp, hiệu năng dẫn đầu phân khúc";
                    color = "#1d1d1f"; // Đen sang trọng
                }

                <div class="clean-slide">
                    <div class="clean-container">
                        <div class="clean-info">
                            <span class="c-badge" style="background: @color">@label</span>
                            <h1 class="c-title">@sp.TenDienThoai</h1>
                            <p class="c-slogan">@slogan</p>

                            <div class="c-price-wrapper">
                                <span class="c-price-label">Giá độc quyền:</span>
                                <span class="c-price-val">@sp.DonGia.ToString("N0")</span>
                                <span class="c-price-unit">đ</span>
                            </div>

                            <p class="c-brand">Phân phối chính hãng: <strong>@sp.HangDienThoaiNavigation?.TenHangDienThoai</strong></p>

                            <div class="c-cta">
                                <a href="/ChiTietSanPham/Index/@sp.MaDienThoai" class="c-btn-main">SĂN NGAY <i class="fas fa-arrow-right"></i></a>
                            </div>
                        </div>

                        <div class="clean-image">
                            <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" class="c-img-static">
                        </div>
                    </div>
                </div>
            }
        </div>
    </section>

    <div class="sidebar-promos" id="adsWidget">
        <div class="close-ads" onclick="document.getElementById('adsWidget').style.display='none'">
            <i class="fas fa-times-circle"></i>
        </div>

        @foreach (var hang in Model.DanhSachHang.Take(2))
        {
            // lấy ảnh sản phẩm mới nhất của hãng đó trong toàn bộ DB
            var spShow = Model.SanPhamMoi.FirstOrDefault(s => s.HangDienThoai == hang.MaHangDienThoai);

            <div class="pro-promo-card @(hang.TenHangDienThoai == "Apple" ? "apple-theme" : "samsung-theme")">
                <div class="promo-badge">HOT DEAL</div>
                <div class="promo-body">
                    <div class="text-section">
                        <h4 class="brand-name">@hang.TenHangDienThoai</h4>
                        <p class="promo-desc">Giá ưu đãi cuối tuần</p>
                    </div>
                    <div class="image-section">
                        @if (spShow != null)
                        {
                            <img src="@spShow.Thumbnail" class="floating-img" alt="promo">
                        }
                        else
                        {
                            <i class="fas fa-mobile-alt placeholder-icon"></i>
                        }
                    </div>
                </div>
                <a href="/Product/Index?hangId=@hang.MaHangDienThoai" class="pro-btn">
                    Săn Ngay <i class="fas fa-bolt"></i>
                </a>
            </div>
        }
    </div>
    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <div class="content-layout">
                <aside class="sidebar">
                    <h3 class="sidebar-title">Danh Mục Sản Phẩm</h3>
                    <ul class="sidebar-menu">
                        @* Nên dùng foreach đổ data từ Model.DanhSachHang ở đây để Sidebar chạy động *@
                        @foreach (var hang in Model.DanhSachHang)
                        {
                            <li><a href="/Product/Index?hangId=@hang.MaHangDienThoai">@hang.TenHangDienThoai <i class="fas fa-chevron-right"></i></a></li>
                        }
                        <li><a href="#">Phụ Kiện <i class="fas fa-chevron-right"></i></a></li>
                    </ul>
                    <div class="sidebar-banner">
                        <h3>TẤT CẢ-MỚI-4K</h3>
                        <p>CAMERA ĐIỆN THOẠI</p>
                        <div class="price">$79<sup>99</sup></div>
                        <button class="hero-btn">Bắt Đầu Mua</button>
                    </div>
                </aside>

                <div class="products-section">
                    @* 1. Tiêu đề chuẩn Clean Style *@
                    <div class="section-header-modern">
                        <h2 class="modern-grid-title">Sản Phẩm Hot Trong Ngày</h2>
                    </div>

                    @* 2. Lưới sản phẩm (5 cột) *@
                    <div class="products-grid">
                        @foreach (var sp in Model.SanPhamMoi)
                        {
                            bool isSale = sp.DonGia < 10000000;
                            bool isSuperHot = sp.LuotXem > 2000;

                            <div class="product-card">
                                @if (isSuperHot)
                                {
                                    <div>HOT</div>
                                }
                                else if (isSale)
                                {
                                    <div>GIẢM GIÁ</div>
                                }

                                <div class="product-category">@sp.HangDienThoaiNavigation?.TenHangDienThoai</div>

                                <h3 class="product-name">
                                    <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">@sp.TenDienThoai</a>
                                </h3>

                                <div class="product-image">
                                    <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">
                                        <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" onerror="this.src='/images/no-image.png'">
                                    </a>
                                </div>

                                <div class="price-action-row">
                                    <div class="price-box">
                                        <span class="product-price @(isSale ? "sale-text" : "normal-text")">
                                            @sp.DonGia.ToString("N0")đ
                                        </span>

                                        @if (isSale)
                                        {
                                            <span class="old-price">@((sp.DonGia * 1.15m).ToString("N0"))đ</span>
                                        }
                                    </div>
                                    <button class="btn-cart-round" onclick="addToCart('@sp.MaDienThoai')">
                                        <i class="fas fa-shopping-cart"></i>
                                    </button>
                                </div>

                                <div class="hover-footer">
                                    <div class="footer-action" onclick="addToWishlist('@sp.MaDienThoai')">
                                        <i class="far fa-heart"></i> Wishlist
                                    </div>
                                    <div class="footer-action" onclick="addToCompare('@sp.MaDienThoai', '@sp.TenDienThoai', '@sp.Thumbnail', '@sp.DonGia', '@sp.Ram', '@sp.DungLuongPin')">
                                        <i class="fas fa-sync-alt"></i> Compare
                                    </div>
                                </div>
                            </div>
                        }

                    </div> 

                    @* 3. Phân trang *@
                    <div class="pagination">
                        @if (ViewBag.CurrentPage > 1)
                        {
                            <a href="?page=@(ViewBag.CurrentPage - 1)" class="page-btn"><i class="fas fa-chevron-left"></i></a>
                        }

                        @for (int i = 1; i <= ViewBag.TotalPages; i++)
                        {
                            <a href="?page=@i" class="page-btn @(i == ViewBag.CurrentPage ? "active" : "")">@i</a>
                        }

                        @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                        {
                            <a href="?page=@(ViewBag.CurrentPage + 1)" class="page-btn"><i class="fas fa-chevron-right"></i></a>
                        }
                    </div>
                </div> 
            </div> 
        </div>
    </div>


    <!-- Brands Section -->
    <section class="brands-section">
        <div class="container">
            <div class="brands-slider">
                <div class="brand-logo">△ apple</div>
                <div class="brand-logo">samsung</div>
                <div class="brand-logo">xiaomi</div>
                <div class="brand-logo">oppo</div>
                <div class="brand-logo">REALME</div>
            </div>
        </div>
    </section>

    <div class="triple-section">

        <div class="section-box">
            <h3>Sản Phẩm Mới Về</h3>
            @foreach (var sp in Model.SanPhamMoiVe)
            {
                <div class="mini-product">
                    <div class="mini-img">
                        <span class="badge-new">NEW</span>
                        <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" onerror="this.src='/images/no-image.png'">
                    </div>
                    <div class="mini-info">
                        <div class="mini-name">
                            <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">@sp.TenDienThoai</a>
                        </div>
                        <div class="rating">★★★★★</div>
                        <div class="mini-price">@sp.DonGia.ToString("N0")đ</div>
                    </div>
                </div>
            }
        </div>

        <div class="section-box">
            <h3>Sản phẩm bán chạy nhất</h3>
            @foreach (var sp in Model.SanPhamBanChay)
            {
                <div class="mini-product">
                    <div class="mini-img">
                        <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" onerror="this.src='/images/no-image.png'">
                    </div>
                    <div class="mini-info">
                        <div class="mini-name">
                            <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">@sp.TenDienThoai</a>
                        </div>
                        <div class="rating">★★★★★</div>
                        <div class="mini-price">@sp.DonGia.ToString("N0")đ</div>
                    </div>
                </div>
            }
        </div>

        <div class="section-box">
            <h3>Sản phẩm đã xem gần đây</h3>
            @if (Model.SanPhamDaXem != null && Model.SanPhamDaXem.Any())
            {
                @foreach (var sp in Model.SanPhamDaXem)
                {
                    <div class="mini-product">
                        <div class="mini-img">
                            <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" onerror="this.src='/images/no-image.png'">
                        </div>
                        <div class="mini-info">
                            <div class="mini-name">
                                <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">@sp.TenDienThoai</a>
                            </div>
                            <div class="rating">★★★★★</div>
                            <div class="mini-price">@sp.DonGia.ToString("N0")đ</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="no-viewed-data" style="padding: 15px; text-align: center; color: #999; font-style: italic; border: 1px dashed #ddd; border-radius: 5px;">
                    Bạn chưa xem sản phẩm nào.
                </div>
            }
        </div>

        <div class="smart-banner">
            <div class="sb-header">
                <div class="sb-title">
                    iPhone<strong>17</strong>
                    <div class="sb-subtitle">Sức mạnh từ Titan</div>
                </div>
                <div class="sb-price-group">
                    <div class="sb-label">Giá độc quyền từ</div>
                    <div class="sb-price">45.000.000<sup>đ</sup></div>
                </div>
            </div>
            <div class="sb-image">
                <img src="/images/iphone17prm.png" alt="Promo" onerror="this.src='/images/no-image.png'">
            </div>
        </div>
    </div>

    <section class="premium-service-section">
        <div class="container">
            <div class="bento-container">

                <div class="bento-card card-shipping" onclick="location.href='/Home/About#shipping'">
                    <div class="card-text">
                        <div class="bento-icon"><i class="fas fa-bolt"></i></div>
                        <h3 style="font-size: 28px;">Giao hàng hỏa tốc<br>trong 2 giờ</h3>
                        <p>Hệ thống vận chuyển chuyên nghiệp nội thành HCM & Hà Nội. Miễn phí đơn từ 5tr.</p>
                    </div>
                    <img src="https://cdn-icons-png.flaticon.com/512/726/726455.png" alt="Shipping Fast">
                </div>

                <div class="bento-card" onclick="location.href='/Home/About#warranty'">
                    <div class="bento-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="card-text">
                        <h3>1 Đổi 1<br>Trong 30 ngày</h3>
                        <p>Yên tâm tuyệt đối với chính sách đặc quyền bảo hành lỗi là đổi máy mới.</p>
                    </div>
                </div>

                <div class="bento-card" onclick="location.href='/Home/About#installment'">
                    <div class="bento-icon"><i class="fas fa-credit-card"></i></div>
                    <div class="card-text">
                        <h3>Trả góp 0%<br>Lãi suất</h3>
                        <p>Duyệt hồ sơ nhanh qua thẻ tín dụng hoặc CCCD trong 5 phút.</p>
                    </div>
                </div>

                <div class="bento-card" onclick="location.href='/Contact/Index'">
                    <div class="bento-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="card-text">
                        <h3>Hỗ trợ 24/7<br>Tech Expert</h3>
                        <p>Đội ngũ chuyên gia công nghệ luôn sẵn sàng tư vấn tận tâm.</p>
                    </div>
                </div>

                <div class="bento-item bento-card" onclick="location.href='/Home/About#trade-in'">
                    <div class="bento-icon"><i class="fas fa-sync-alt"></i></div>
                    <div class="card-text">
                        <h3>Thu cũ đổi mới<br>Trợ giá 2 Triệu</h3>
                        <p>Lên đời siêu phẩm tiết kiệm tối đa chi phí cho khách hàng thân thiết.</p>
                    </div>
                </div>

            </div>
        </div>
    </section>

    <!-- Newsletter -->
    <section class="newsletter">
        <div class="container">
            <div class="newsletter-content" id="newsletter-area">
                <div class="newsletter-left">
                    <div class="newsletter-icon"><i class="far fa-envelope"></i></div>
                    <div class="newsletter-text">
                        <h3>Đăng Ký Nhận Bản Tin</h3>
                        <p>...và nhận phiếu giảm giá <strong>500.000đ</strong> cho lần mua hàng đầu tiên</p>
                    </div>
                </div>
                <div class="newsletter-form">
                    <input type="email" id="newsletterEmail" class="newsletter-input" placeholder="Nhập địa chỉ email của bạn">
                    <button class="newsletter-btn" onclick="subscribeNewsletter()">Đăng Ký</button>
                </div>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo"><i class="fas fa-phone-volume"></i></div>
                    <div class="footer-info">
                        <h3>Có Câu Hỏi? Gọi Cho Chúng Tôi 24/7!</h3>
                        <div class="footer-phone">(800) 8001-8588, (0600) 874 548</div>

                        <p class="footer-description">
                            Electro Mobile là hệ thống bán lẻ điện thoại hiện đại, mang đến trải nghiệm
                            mua sắm trực tuyến mượt mà và là điểm đến tin cậy cho các tín đồ công nghệ.
                        </p>

                        <div class="footer-address">
                            <strong>Thông Tin Liên Hệ</strong><br>
                            17 Princess Road, London, NW1 8JR, UK
                        </div>

                        <ul class="social-vertical">
                            <li><a href="#"><i class="fab fa-facebook-f"></i> Facebook</a></li>
                            <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                            <li><a href="#"><i class="fab fa-youtube"></i> Youtube</a></li>
                            <li><a href="#"><i class="fab fa-linkedin-in"></i> LinkedIn</a></li>
                            <li><a href="#"><i class="fab fa-pinterest"></i> Pinterest</a></li>
                        </ul>
                    </div>
                </div>

                <div class="footer-column">
                    <h4>Tìm Nhanh</h4>
                    <ul>
                        <li><a href="#">Laptop & Máy Tính</a></li>
                        <li><a href="#">Camera & Nhiếp Ảnh</a></li>
                        <li><a href="#">Điện Thoại & Máy Tính Bảng</a></li>
                        <li><a href="#">TV & Âm Thanh</a></li>
                        <li><a href="#">Thiết Bị Đeo</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>Chăm Sóc Khách Hàng</h4>
                    <ul>
                        <li><a href="#">Tài Khoản Của Tôi</a></li>
                        <li><a href="#">Theo Dõi Đơn Hàng</a></li>
                        <li><a href="#">Hoàn Trả / Đổi Hàng</a></li>
                        <li><a href="#">Câu Hỏi Thường Gặp</a></li>
                        <li><a href="#">Hỗ Trợ Sản Phẩm</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>Về Chúng Tôi</h4>
                    <ul>
                        <li><a href="#">Giới Thiệu</a></li>
                        <li><a href="#">Liên Hệ</a></li>
                        <li><a href="#">Danh Sách Yêu Thích</a></li>
                        <li><a href="#">Chính Sách Bảo Mật</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="container">
                <div class="footer-bottom-content">
                    <div class="copyright">
                        © Electro - Bản Quyền Đã Được Bảo Lưu
                    </div>
                    <div class="payment-methods">
                        <div class="payment-icon">VISA</div>
                        <div class="payment-icon">PayPal</div>
                        <div class="payment-icon">MasterCard</div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <div class="toggle-btn"><i class="fas fa-moon"></i></div>
        <div class="toggle-btn"><i class="fas fa-sun"></i></div>
    </div>

    <!-- Scroll to Top -->
    <div class="scroll-top">
        <i class="fas fa-arrow-up"></i>
    </div>
    <div id="quick-chat-box" class="card shadow" style="display:none; position:fixed; bottom:140px; right:20px; width:300px; z-index:1001; border-radius: 15px; border: none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="border-radius: 15px 15px 0 0;">
            <span class="fw-bold"><i class="fas fa-headset me-2"></i> Chat trực tuyến</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>
        <div class="card-body p-0">
            <div id="chat-messages-list" style="height: 200px; overflow-y: auto; padding: 15px; background: #f8f9fa; font-size: 0.85rem;">
                <div class="text-muted small text-center mb-2">Chào mừng bạn đến với Electro!</div>
            </div>

            <form id="chatFormRealTime" class="p-2 border-top">
                <input type="hidden" id="chatName" value="@Context.Session.GetString("TenUser")">
                <input type="hidden" id="chatEmail" value="@Context.Session.GetString("EmailUser")">

                @if (Context.Session.GetString("MaKH") == null)
                {
                    <input type="text" id="guestName" class="form-control form-control-sm mb-1" placeholder="Tên bạn" required>
                    <input type="email" id="guestEmail" class="form-control form-control-sm mb-1" placeholder="Email của bạn" required>
                }

                <div class="input-group">
                    <input type="text" id="chatMessage" class="form-control form-control-sm" placeholder="Nhập tin nhắn..." required>
                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>
    <div class="chat-widget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999;" onclick="toggleChat()">
        @* Thêm lại onclick ở đây *@
        <div class="chat-icon" style="background: #0084ff; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <i class="fas fa-comment-dots" style="font-size: 24px;"></i>
        </div>
    </div>
<div id="quick-compare-bar" class="compare-bar">
        <div class="container">
            <div class="compare-left-group">
                <div class="compare-guide-text">Chọn ít nhất 2 sản phẩm để so sánh</div>
                <div id="compare-list-items"></div>
            </div>
            <div class="compare-right-group">
                <button class="btn-view-compare shadow-sm" onclick="showCompareModal()">Xem so sánh</button>
                <a href="javascript:void(0)" onclick="clearAllCompare()" style="color: #999; text-decoration: none; font-size: 13px; margin-left:15px;">Clear all</a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="compareModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen"> 
            <div class="modal-content border-0">
                <div class="modal-header container-fluid px-5 pt-4">
                    <h2 class="modal-title fw-bold" style="color: #333e48; font-size: 28px;">Compare Products</h2>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" style="font-size: 20px;"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="compare-table-wrapper">
                        <table class="table compare-list-table mb-0" id="compare-table-content">
                            </table>
                    </div>
                </div>
                <div class="modal-footer border-0 p-4 shadow-sm">
                    <button type="button" class="btn btn-dark px-5 py-2 rounded-pill" data-bs-dismiss="modal">Đóng bảng so sánh</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function(){
            // Khởi tạo slider
            $(".hero-slider-owl").owlCarousel({
                items: 1, loop: true, autoplay: true, dots: true, nav: false
            });
        });

        // 1. CHỨC NĂNG GIỎ HÀNG 
        function addToCart(maDT) {
        var userName = $('.user-name-label').text();

            if (!userName || userName.trim() === "") {
                alert("Vui lòng đăng nhập để thêm sản phẩm vào giỏ hàng!");

                // Cuộn lên đầu để đăng nhập
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Ép popup hiện ra bằng class mới
                $('.user-dropdown-container').addClass('is-open');

                // Tự động đóng popup sau 5 giây để
                setTimeout(function() {
                    $('.user-dropdown-container').removeClass('is-open');
                }, 5000);

                return;
            }
            $.ajax({
                url: '/GioHang/AddToCart',
                type: 'POST',
                data: { maDT: maDT, qty: 1 },
                success: function (response) {
                    if (response.success) {
                        alert(response.message);
                        var currentBadge = parseInt($('.icon-badge').first().text()) || 0;
                        $('.icon-badge').text(currentBadge + 1);
                    } else {
                        alert("Lỗi: " + response.message);
                    }
                },
                error: function () {
                    alert("Không thể kết nối đến hệ thống giỏ hàng.");
                }
            });
        }
        // Xử lý Thêm vào yêu thích (Session)
        function addToWishlist(maDT) {
            $.post('/Home/AddToWishlist', { maDT: maDT }, function (rp) {
                if (rp.success) {
                    alert(rp.message);

                    // Tìm đến badge yêu thích và tăng số lượng
                    let badge = $('.wishlist-badge');
                    let count = parseInt(badge.text()) || 0;
                    badge.text(count + 1);
                } else {
                    alert(rp.message);
                }
            });
        }

        //CHỨC NĂNG NEWSLETTER (HIỂN THỊ THÔNG BÁO TẠI CHỖ)
        function subscribeNewsletter() {
            var email = $('#newsletterEmail').val();

            // Sử dụng @@ để tránh gạch đỏ
            if (!email || !email.includes('@@')) {
                alert("Vui lòng nhập email hợp lệ!");
                return;
            }

            $.ajax({
                url: '/Home/SubscribeNewsletter',
                type: 'POST',
                data: { email: email },
                success: function (response) {
                    if (response.success) {
                        // thong bao chữ cảm ơn
                        $('#newsletter-area').html(`
                            <div style="background: #e6ffed; color: #155724; padding: 15px 30px; border-radius: 5px; width: 100%; border: 1px solid #c3e6cb; text-align: left;">
                                Cảm ơn bạn đã liên hệ với chúng tôi! Chúng tôi sẽ liên lạc lại với bạn trong thời gian ngắn nhất.
                            </div>
                        `);
                    } else {
                        alert(response.message);
                    }
                },
                error: function () {
                    alert("Lỗi kết nối máy chủ");
                }
            });
        }
    </script>
    <script>
        // 1. Khởi tạo danh sách lưu trữ
        let compareList = [];

        // 2. Hàm thêm sản phẩm (Đã sửa để nhận đủ dữ liệu từ View)
        function addToCompare(id, name, img, price, ram, pin) {
            if (compareList.find(x => x.id === id)) {
                alert("Sản phẩm đã có trong danh sách so sánh!");
                return;
            }
            if (compareList.length >= 4) {
                alert("Bạn chỉ có thể so sánh tối đa 4 sản phẩm!");
                return;
            }

            // Xử lý làm sạch dữ liệu trước khi lưu (loại bỏ chữ 'đ', dấu chấm, v.v.)
            let cleanPrice = typeof price === 'string' ? price.replace(/[^0-9]/g, '') : price;

            compareList.push({
                id: id,
                name: name,
                img: img,
                price: parseFloat(cleanPrice) || 0,
                ram: parseInt(ram) || 0,
                pin: parseInt(pin) || 0
            });
            // Cập nhật số lượng sản phẩm so sánh lên Header
            $('#compare-count').text(compareList.length);

            renderCompareBar();
        }

        // 3. Hàm xóa sản phẩm
        function removeFromCompare(id) {
            compareList = compareList.filter(x => x.id !== id);
            renderCompareBar();
        }

        // 4. Hàm xóa tất cả
        function clearAllCompare() {
            compareList = [];
            renderCompareBar();
        }

        // 5. Hàm vẽ thanh so sánh (Dàn hàng ngang chuẩn mẫu)
        function renderCompareBar() {
            const bar = $('#quick-compare-bar');
            const list = $('#compare-list-items');
            list.empty();

            if (compareList.length > 0) {
                bar.fadeIn(300);
                compareList.forEach(item => {
                    list.append(`
                        <div class="mini-compare-item">
                            <img src="${item.img}" onerror="this.src='/images/no-image.png'">
                            <button class="remove-mini-item" onclick="removeFromCompare('${item.id}')">×</button>
                        </div>
                    `);
                });
                // Vẽ các ô trống nét đứt còn lại
                for(let i = compareList.length; i < 4; i++) {
                    list.append('<div class="mini-compare-placeholder"></div>');
                }
            } else {
                bar.fadeOut(300);
            }
        }

        // 6. Hàm hiển thị bảng so sánh NỔI LÊN MÀN HÌNH (Sửa lỗi toLocaleString)
        function showCompareModal() {
            if (compareList.length < 2) {
                alert("Vui lòng chọn ít nhất 2 sản phẩm để so sánh!");
                return;
            }

            const table = $('#compare-table-content');
            table.empty();

            // --- Hàng 1: Ảnh và Tên ---
            let headerRow = `<tr><td class="attr-name border-0">Sản phẩm</td>`;
            compareList.forEach(item => {
                headerRow += `
                    <td class="text-center border-0 px-4 py-4">
                        <img src="${item.img}" class="compare-img d-block mx-auto" onerror="this.src='/images/no-image.png'">
                        <div class="fw-bold text-dark small mt-2">${item.name || 'N/A'}</div>
                    </td>`;
            });
            table.append(headerRow + `</tr>`);

            // --- Các hàng thông số: Giá, RAM, Pin ---
            const specs = [
                { label: "Giá bán (đ)", key: "price", better: "min" },
                { label: "RAM (GB)", key: "ram", better: "max" },
                { label: "Pin (mAh)", key: "pin", better: "max" }
            ];

            specs.forEach(s => {
                let row = `<tr><td class="attr-name">${s.label}</td>`;

                // Lấy danh sách các giá trị an toàn để so sánh
                let vals = compareList.map(item => item[s.key] || 0);
                let best = s.better === "max" ? Math.max(...vals) : Math.min(...vals.filter(v => v > 0));

                compareList.forEach(item => {
                    let currentVal = item[s.key] || 0;

                    // Logic tô màu xanh (Highlight)
                    let isBest = (currentVal === best && new Set(vals).size > 1 && best !== 0);

                    // Hiển thị giá tiền hoặc thông số (Chống lỗi undefined toLocaleString)
                    let displayVal = "Liên hệ";
                    if (currentVal > 0) {
                        displayVal = (s.key === "price") ? currentVal.toLocaleString('vi-VN') : currentVal;
                    }

                    row += `<td class="text-center py-3 ${isBest ? 'highlight-best' : ''}">${displayVal}</td>`;
                });
                table.append(row + `</tr>`);
            });

            // Kích hoạt Modal (Sử dụng try-catch để tránh lỗi Promise của Bootstrap)
            try {
                var myModal = new bootstrap.Modal(document.getElementById('compareModal'));
                myModal.show();
            } catch (err) {
                console.error("Bootstrap Modal chưa sẵn sàng:", err);
                // Fallback nếu Bootstrap Modal bị lỗi
                $('#compareModal').modal('show');
            }
        }
    </script>
    <script>
        function toggleAuth(type) {
            // Lấy hai khối nội dung dựa trên ID bạn đã đặt
            const loginSec = document.getElementById('loginSection');
            const registerSec = document.getElementById('registerSection');

            if (type === 'register') {
                // Sử dụng style.display để ẩn/hiện
                loginSec.style.display = 'none';
                registerSec.style.display = 'block';
            } else {
                loginSec.style.display = 'block';
                registerSec.style.display = 'none';
            }
        }

        // Chống việc menu tự đóng lại khi bấm vào các ô nhập liệu (Nếu dùng Bootstrap)
        document.querySelector('.user-dropdown-content').addEventListener('click', function (e) {
            e.stopPropagation();
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // 1. Khởi tạo kết nối đến Hub
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

        // 2. Lắng nghe tin nhắn từ Server bắn về
        connection.on("ReceiveMessage", function (user, message, time) {
            var msgHtml = `
                <div class="mb-2">
                    <strong style="color: #0084ff;">${user}</strong> <small class="text-muted">${time}</small><br/>
                    <span class="bg-white p-1 rounded shadow-sm d-inline-block">${message}</span>
                </div>`;
            $("#chat-messages-list").append(msgHtml);

            // Tự động cuộn xuống tin nhắn mới nhất
            var chatList = document.getElementById("chat-messages-list");
            chatList.scrollTop = chatList.scrollHeight;
        });

        // 3. Bắt đầu kết nối
        connection.start().catch(function (err) {
            return console.error(err.toString());
        });

        // 4. Xử lý khi nhấn nút Gửi
        $(document).on('submit', '#chatFormRealTime', function(e) {
            e.preventDefault();

            // Lấy tên: Ưu tiên tên từ Session, nếu không có thì lấy ở ô nhập guest
            var user = $('#chatName').val() || $('#guestName').val() || "Khách lạ";
            var email = $('#chatEmail').val() || "guest@mail.com";
            var message = $('#chatMessage').val();

            // Gọi hàm SendMessage trong ChatHub.cs
            connection.invoke("SendMessage", user, email, message).then(function() {
                $('#chatMessage').val(''); // Xóa ô nhập sau khi gửi
            }).catch(function (err) {
                return console.error(err.toString());
            });
        });

        function toggleChat() {
            $("#quick-chat-box").fadeToggle(200);
        }
    </script>
</body>
</html>

