@model List<DoAn3Tuan_WebPhone.Models.DienThoai>
@{
    ViewData["Title"] = "Danh sách sản phẩm";
}
@{
    Layout = null; // Để tạm null cho giống Home của ông
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh Sách Sản Phẩm - Toàn Cầu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                Chào mừng đến với Cửa Hàng Điện Thoại Toàn Cầu
            </div>
            <div class="top-bar-right">
                <a href="#"><i class="fas fa-map-marker-alt"></i> Tìm Cửa Hàng</a>
                <a href="#"><i class="fas fa-truck"></i> Theo Dõi Đơn Hàng</a>
                <a href="#"><i class="fas fa-shopping-bag"></i> Cửa Hàng</a>
                <a href="#"><i class="fas fa-user"></i> Tài Khoản Của Tôi</a>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">

                <!-- LOGO -->
                <a href="/" class="logo">electro<span>.</span></a>

                <!-- MENU -->
                <div class="burger-menu">
                    <i class="fas fa-bars"></i>
                </div>

                <!-- SEARCH FORM -->
                <div class="search-container">
                    <form action="/Search" method="get" style="display: flex; width: 100%;">

                        <input type="text" name="keyword" placeholder="Tìm kiếm sản phẩm..." value="@Context.Request.Query["keyword"]">

                        <button type="submit"><i class="fas fa-search"></i></button>
                    </form>
                </div>

                <!-- ICONS -->
                <div class="header-icons">

                    <a href="#" class="icon-btn">
                        <i class="fas fa-sync-alt"></i>
                        <span class="icon-badge">0</span>
                    </a>

                    <a href="#" class="icon-btn">
                        <i class="far fa-heart"></i>
                    </a>

                    <!-- USER DROPDOWN -->
                    <div class="user-dropdown-container">
                        @if (Context.Session.GetString("MaKH") != null)
                        {
                            <a href="#" class="icon-btn user-icon">
                                <i class="fas fa-user"></i>
                                <span class="user-name-label">@Context.Session.GetString("TenUser")</span>
                            </a>
                            <div class="user-dropdown-content logged-in">
                                <h4 class="dropdown-title">Tài khoản của tôi</h4>
                                <a href="/Account/Profile"><i class="fas fa-id-card me-2"></i> Trang cá nhân</a>
                                <a href="/DonHang/History"><i class="fas fa-shopping-bag me-2"></i> Đơn hàng đã mua</a>
                                <div class="dropdown-divider"></div>
                                <a href="/Account/Logout" class="text-danger"><i class="fas fa-sign-out-alt me-2"></i> Đăng xuất</a>
                            </div>
                        }
                        else
                        {
                            <a href="#" class="icon-btn user-icon">
                                <i class="far fa-user"></i>
                            </a>

                            <div class="user-dropdown-content" id="authDropdown">
                                <div id="loginSection">
                                    <h4 class="dropdown-title">Đăng nhập</h4>
                                    <form action="/Account/Login" method="post">
                                        <input type="text" name="username" class="dropdown-input" placeholder="Tên đăng nhập" required />
                                        <input type="password" name="password" class="dropdown-input" placeholder="Mật khẩu" required />
                                        <button type="submit" class="btn-login">Đăng nhập</button>
                                    </form>
                                    <div class="dropdown-footer">
                                        <span>Chưa có tài khoản?</span>
                                        <a href="javascript:void(0)" onclick="toggleAuth('register')" class="link-register">Đăng ký ngay</a>
                                    </div>
                                </div>

                                <div id="registerSection" style="display: none;">
                                    <h4 class="dropdown-title">Đăng ký</h4>
                                    <form action="/Account/Register" method="post">
                                        <input type="text" name="hoten" class="dropdown-input" placeholder="Họ và tên" required />
                                        <input type="text" name="username" class="dropdown-input" placeholder="Tên đăng nhập" required />
                                        <input type="email" name="email" class="dropdown-input" placeholder="Email" required />
                                        <input type="password" name="password" class="dropdown-input" placeholder="Mật khẩu" required />
                                        <button type="submit" class="btn-login btn-register-submit">Tạo tài khoản</button>
                                    </form>
                                    <div class="dropdown-footer text-center mt-2">
                                        <a href="javascript:void(0)" onclick="toggleAuth('login')" class="link-register small">Quay lại Đăng nhập</a>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <!-- END USER DROPDOWN -->
                    <!-- CART -->
                    <div class="cart-info">
                        <a href="#" class="icon-btn">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="icon-badge">0</span>
                        </a>
                        <span class="cart-price">0 ₫</span>
                    </div>

                </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="main-nav">
        <div class="container">
            <div class="nav-content">
                <ul class="nav-menu">
                    <li><a asp-controller="Home" asp-action="Index">Trang Chủ</a></li>

                    <li><a asp-controller="Product" asp-action="Index">Sản Phẩm</a></li>

                    <li><a asp-controller="Home" asp-action="About">Giới Thiệu</a></li>

                    <li><a asp-controller="Contact" asp-action="Index">Liên Hệ</a></li>
                </ul>
                <div class="shipping-banner">
                    Miễn Phí Vận Chuyển Đơn Hàng Từ $50+
                </div>
            </div>
        </div>
    </nav>


    <div class="container mt-5">
        <h2 class="mb-4">Tất Cả Sản Phẩm</h2>

        <div class="products-grid">
            @if (Model.Any())
            {
                @foreach (var sp in Model)
                {
                    //giảm giá và hot
                    bool isSale = sp.DonGia < 10000000;
                    bool isSuperHot = sp.LuotXem > 2000;

                    <div class="product-card">
                        @* 1. Hiển thị Badge *@
                        @if (isSuperHot)
                        {
                            <div class="badge-status hot">HOT</div>
                        }
                        else if (isSale)
                        {
                            <div class="badge-status sale">GIẢM GIÁ</div>
                        }

                        <div class="product-category">@sp.HangDienThoaiNavigation?.TenHangDienThoai</div>

                        <h3 class="product-name">
                            <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">@sp.TenDienThoai</a>
                        </h3>

                        <div class="product-image">
                            <a href="/ChiTietSanPham/Index/@sp.MaDienThoai">
                                <img src="@sp.Thumbnail" alt="@sp.TenDienThoai" onerror="this.src='/images/no-image.png'">
                            </a>
                        </div>

                        <div class="price-action-row">
                            <div class="price-box">
                                <span class="product-price">@sp.DonGia.ToString("N0")đ</span>
                            </div>
                            <button class="btn-cart-round"><i class="fas fa-shopping-cart"></i></button>
                        </div>

                        @* 3. Thêm Footer Hover cho đồng bộ *@
                        <div class="hover-footer">
                            <div class="footer-action"><i class="far fa-heart"></i> Wishlist</div>
                            <div class="footer-action"><i class="fas fa-sync-alt"></i> Compare</div>
                        </div>
                    </div>
                }
            }
            else
            {
                <p>Không tìm thấy sản phẩm nào phù hợp.</p>
            }
        </div>

        <div class="pagination mt-5 text-center" style="display:flex; justify-content:center; gap:10px;">
            @for (int i = 1; i <= ViewBag.TotalPages; i++)
            {
                <a href="@Url.Action("Index", new { page = i, hangId = ViewBag.CurrentHang, searchString = ViewBag.CurrentSearch })"
                   class="page-btn @(i == ViewBag.CurrentPage ? "active" : "")"
                   style="padding: 10px 15px; border: 1px solid #ddd; text-decoration:none;">@i</a>
            }
        </div>
    </div>

    <!-- Footer -->
    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-brand">
                    <div class="footer-logo"><i class="fas fa-phone-volume"></i></div>
                    <div class="footer-info">
                        <h3>Có Câu Hỏi? Gọi Cho Chúng Tôi 24/7!</h3>
                        <div class="footer-phone">(800) 8001-8588, (0600) 874 548</div>

                        <p class="footer-description">
                            Electro Mobile là hệ thống bán lẻ điện thoại hiện đại, mang đến trải nghiệm
                            mua sắm trực tuyến mượt mà và là điểm đến tin cậy cho các tín đồ công nghệ.
                        </p>

                        <div class="footer-address">
                            <strong>Thông Tin Liên Hệ</strong><br>
                            17 Princess Road, London, NW1 8JR, UK
                        </div>

                        <ul class="social-vertical">
                            <li><a href="#"><i class="fab fa-facebook-f"></i> Facebook</a></li>
                            <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                            <li><a href="#"><i class="fab fa-youtube"></i> Youtube</a></li>
                            <li><a href="#"><i class="fab fa-linkedin-in"></i> LinkedIn</a></li>
                            <li><a href="#"><i class="fab fa-pinterest"></i> Pinterest</a></li>
                        </ul>
                    </div>
                </div>

                <div class="footer-column">
                    <h4>Tìm Nhanh</h4>
                    <ul>
                        <li><a href="#">Laptop & Máy Tính</a></li>
                        <li><a href="#">Camera & Nhiếp Ảnh</a></li>
                        <li><a href="#">Điện Thoại & Máy Tính Bảng</a></li>
                        <li><a href="#">TV & Âm Thanh</a></li>
                        <li><a href="#">Thiết Bị Đeo</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>Chăm Sóc Khách Hàng</h4>
                    <ul>
                        <li><a href="#">Tài Khoản Của Tôi</a></li>
                        <li><a href="#">Theo Dõi Đơn Hàng</a></li>
                        <li><a href="#">Hoàn Trả / Đổi Hàng</a></li>
                        <li><a href="#">Câu Hỏi Thường Gặp</a></li>
                        <li><a href="#">Hỗ Trợ Sản Phẩm</a></li>
                    </ul>
                </div>

                <div class="footer-column">
                    <h4>Về Chúng Tôi</h4>
                    <ul>
                        <li><a href="#">Giới Thiệu</a></li>
                        <li><a href="#">Liên Hệ</a></li>
                        <li><a href="#">Danh Sách Yêu Thích</a></li>
                        <li><a href="#">Chính Sách Bảo Mật</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <div class="container">
                <div class="footer-bottom-content">
                    <div class="copyright">
                        © Electro - Bản Quyền Đã Được Bảo Lưu
                    </div>
                    <div class="payment-methods">
                        <div class="payment-icon">VISA</div>
                        <div class="payment-icon">PayPal</div>
                        <div class="payment-icon">MasterCard</div>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Theme Toggle -->
    <div class="theme-toggle">
        <div class="toggle-btn"><i class="fas fa-moon"></i></div>
        <div class="toggle-btn"><i class="fas fa-sun"></i></div>
    </div>

    <!-- Scroll to Top -->
    <div class="scroll-top">
        <i class="fas fa-arrow-up"></i>
    </div>

    <div id="quick-chat-box" class="card shadow" style="display:none; position:fixed; bottom:140px; right:20px; width:300px; z-index:1001; border-radius: 15px; border: none;">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center" style="border-radius: 15px 15px 0 0;">
            <span class="fw-bold"><i class="fas fa-headset me-2"></i> Chat trực tuyến</span>
            <button type="button" class="btn-close btn-close-white" onclick="toggleChat()"></button>
        </div>
        <div class="card-body p-0">
            <div id="chat-messages-list" style="height: 200px; overflow-y: auto; padding: 15px; background: #f8f9fa; font-size: 0.85rem;">
                <div class="text-muted small text-center mb-2">Chào mừng bạn đến với Electro!</div>
            </div>

            <form id="chatFormRealTime" class="p-2 border-top">
                <input type="hidden" id="chatName" value="@Context.Session.GetString("TenUser")">
                <input type="hidden" id="chatEmail" value="@Context.Session.GetString("EmailUser")">

                @if (Context.Session.GetString("MaKH") == null)
                {
                    <input type="text" id="guestName" class="form-control form-control-sm mb-1" placeholder="Tên bạn" required>
                    <input type="email" id="guestEmail" class="form-control form-control-sm mb-1" placeholder="Email của bạn" required>
                }

                <div class="input-group">
                    <input type="text" id="chatMessage" class="form-control form-control-sm" placeholder="Nhập tin nhắn..." required>
                    <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-paper-plane"></i></button>
                </div>
            </form>
        </div>
    </div>
    <div class="chat-widget" style="position: fixed; bottom: 80px; right: 20px; z-index: 999;" onclick="toggleChat()">
        @* Thêm lại onclick ở đây *@
        <div class="chat-icon" style="background: #0084ff; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
            <i class="fas fa-comment-dots" style="font-size: 24px;"></i>
        </div>
    </div>
    <script>
        function toggleAuth(type) {
            // Lấy hai khối nội dung dựa trên ID bạn đã đặt
            const loginSec = document.getElementById('loginSection');
            const registerSec = document.getElementById('registerSection');

            if (type === 'register') {
                // Sử dụng style.display để ẩn/hiện
                loginSec.style.display = 'none';
                registerSec.style.display = 'block';
            } else {
                loginSec.style.display = 'block';
                registerSec.style.display = 'none';
            }
        }

        // Chống việc menu tự đóng lại khi bấm vào các ô nhập liệu (Nếu dùng Bootstrap)
        document.querySelector('.user-dropdown-content').addEventListener('click', function (e) {
            e.stopPropagation();
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>

    <script>
        // 1. Khởi tạo kết nối đến Hub
        var connection = new signalR.HubConnectionBuilder().withUrl("/chatHub").build();

        // 2. Lắng nghe tin nhắn từ Server bắn về
        connection.on("ReceiveMessage", function (user, message, time) {
            var msgHtml = `
                <div class="mb-2">
                    <strong style="color: #0084ff;">${user}</strong> <small class="text-muted">${time}</small><br/>
                    <span class="bg-white p-1 rounded shadow-sm d-inline-block">${message}</span>
                </div>`;
            $("#chat-messages-list").append(msgHtml);

            // Tự động cuộn xuống tin nhắn mới nhất
            var chatList = document.getElementById("chat-messages-list");
            chatList.scrollTop = chatList.scrollHeight;
        });

        // 3. Bắt đầu kết nối
        connection.start().catch(function (err) {
            return console.error(err.toString());
        });

        // 4. Xử lý khi nhấn nút Gửi
        $(document).on('submit', '#chatFormRealTime', function(e) {
            e.preventDefault();

            // Lấy tên: Ưu tiên tên từ Session, nếu không có thì lấy ở ô nhập guest
            var user = $('#chatName').val() || $('#guestName').val() || "Khách lạ";
            var email = $('#chatEmail').val() || "guest@mail.com";
            var message = $('#chatMessage').val();

            // Gọi hàm SendMessage trong ChatHub.cs
            connection.invoke("SendMessage", user, email, message).then(function() {
                $('#chatMessage').val(''); // Xóa ô nhập sau khi gửi
            }).catch(function (err) {
                return console.error(err.toString());
            });
        });

        function toggleChat() {
            var chatBox = document.getElementById("quick-chat-box");
            $("#quick-chat-box").fadeToggle(200);
        }
    </script>
</body>
</html>